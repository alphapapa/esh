\documentclass{article}

\usepackage{fontspec}
\newfontfamily{\Symbola}[Mapping=tex-ansi]{Symbola monospacified for Ubuntu Mono}
\newfontfamily{\UbuntuMono}[Mapping=tex-ansi]{Ubuntu Mono}

\newcommand{\ESHFont}{\UbuntuMono}
\DeclareTextFontCommand{\ESHInline}{\UbuntuMono}
\DeclareTextFontCommand{\ESHSpecialChar}{\Symbola}

\usepackage{listings}

\def\coqverb{\verb}
\def\cverb{\lstinline[language=c]}

%% ESH-preamble-here
%% ESH-inline: coq-mode \coqverb|...|
%% ESH-inline: c-mode \cverb|...|

\usepackage[margin=0.75in]{geometry}

\begin{document}

\section*{Coq Code}

It works with inline code as well: \coqverb|int main() {return 0;}|, \cverb|fun x => x|.

%% ESH: coq-mode
\begin{verbatim}
Class FacadeWrapper (WrappingType WrappedType: Type) :=
  { wrap: WrappedType -> WrappingType;
    wrap_inj: forall v v', wrap v = wrap v' -> v = v' }.

Inductive NameTag av T :=
| NTNone : NameTag av T
| NTSome (key1 key2: string) (H: FacadeWrapper (Value av) T) : NameTag av T.

Arguments NTNone {av T}.
Arguments NTSome {av T} key {H}.

Definition NameTagAsStringOption {av T} (nt: NameTag av T) :=
  match nt with
  | NTNone => None
  | NTSome key H => Some key
  end.

Inductive Telescope av : Type :=
| Nil : Telescope av
| Cons : forall T (key: NameTag av T)
           (val: Comp T)
           (tail: T -> Telescope av),
    Telescope av.
\end{verbatim}

\section*{C code:}
%% ESH: c-mode
\begin{verbatim}
static void
x_update_menu_appearance (struct frame *f)
{
  struct x_display_info *dpyinfo = FRAME_DISPLAY_INFO (f);
  XrmDatabase rdb;

  if (dpyinfo
      && (rdb = XrmGetDatabase (FRAME_X_DISPLAY (f)),
      rdb != NULL))
    {
      char line[512];
      char *buf = line;
      ptrdiff_t bufsize = sizeof line;
      Lisp_Object lface = lface_from_face_name (f, Qmenu, true);
      struct face *face = FACE_FROM_ID (f, MENU_FACE_ID);
      const char *myname = SSDATA (Vx_resource_name);
      bool changed_p = false;
#ifdef USE_MOTIF
      const char *popup_path = "popup_menu";
\end{verbatim}
\end{document}