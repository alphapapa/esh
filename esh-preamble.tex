%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DO NOT MODIFY THIS FILE %
%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Instead, redefine the relevant macros in your own source file, **before**
%% including this file.  This file is overwritten every time you run esh2tex.

%%%%%%%%%%%%%%
%% Core ESH %%
%%%%%%%%%%%%%%

% Packages
%%%%%%%%%%

\RequirePackage{xcolor} % TeXLive-recommended
\RequirePackage[normalem]{ulem} % TeXLive-recommended

\RequirePackage{relsize} % TeXLive-latex-extra
\renewcommand{\RSsmallest}{1pt}
\renewcommand{\RSlargest}{50pt}

% Fonts
%%%%%%%

% \ESHFont is for code blocks
\providecommand*{\ESHFont}{\ttfamily}

% \ESHInlineFont is for inline code samples
\providecommand*{\ESHInlineFont}{\ESHFont}

% \ESHInlineBlockFont is for inline code blocks
\providecommand*{\ESHInlineBlockFont}{\ESHFont}

% \ESHFallbackFont is for characters not covered by \ESHFont (XeTeX/LuaTeX only)
\providecommand*{\ESHFallbackFont}{\ESHFont}

% Utils
%%%%%%%

% \ESHNoHyphens disables hyphenation
\providecommand*{\ESHNoHyphens}{\hyphenpenalty=10000}

% \ESHConstantSpace ensures that spaces can't stretch
\providecommand*{\ESHConstantSpace}{\spaceskip=\fontdimen2\font\xspaceskip=0pt}

% \ESHCenterInWidthOf{#A}{#B} prints #B centered in a box as large as #A.
\newdimen\ESHtempdim%
\providecommand*{\ESHCenterInWidthOf}[2]
  {\settowidth\ESHtempdim{#1}%
   \makebox[\ESHtempdim][c]{#2}}

% ESHText switches out of math mode if needed (textnormal amstext-friendly)
\DeclareRobustCommand*{\ESHText}[1]{\ifmmode{\textnormal{#1}}\else{#1}\fi}

\RequirePackage{iftex}
\ifXeTeX
  % \ESHWithFallback{#A} prints #A in the current font if possible, falling back to \ESHFallbackFont
  % Adapted from https://tug.org/pipermail/xetex/2011-November/022319.html
  \def\ESHWithFallback#1{%
    \begingroup
      \def\found{#1}%
      \def\notfound{\ESHFallbackFont#1}%
      \ifnum\XeTeXfonttype\font>0%
        \ifnum\XeTeXcharglyph`#1>0\found\else\notfound\fi
      \else
        \setbox0=\hbox{\tracinglostchars=0\kern1sp#1\expandafter}%
        \ifnum\lastkern=1\notfound\else\found\fi
      \fi
    \endgroup}
\else
  % Fall back to just using \ESHFallbackFont
  \def\ESHWithFallback#1{\ESHFallbackFont#1}
\fi

% \ESH*SpecialChar is used to wrap non-ascii characters, which may need a fallback font
\DeclareRobustCommand*{\ESHInlineSpecialChar}[1]
  {{\ESHFont\ESHWithFallback{#1}}}
\DeclareRobustCommand*{\ESHBlockSpecialChar}[1]
  {{\ESHCenterInWidthOf{\ESHFont{a}}{\ESHInlineSpecialChar{#1}}}}

% \ESH*Raise implements sub/superscripts
\DeclareRobustCommand*{\ESHInlineRaise}[2]
  {\raisebox{#1}{\relsize{-2}#2}}
\DeclareRobustCommand*{\ESHBlockRaise}[2]
  {\rlap{\ESHInlineRaise{#1}{#2}}\hphantom{#2}}

% ESH*Strut implements struts
\newlength{\ESHBaselineskip}
\DeclareRobustCommand*{\ESHBlockStrut}[1]
  {\rule{0pt}{#1\ESHBaselineskip}}

\makeatletter
% ESHUnderline produces a straight underline
\DeclareRobustCommand*{\ESHUnderline}[1]
  {\bgroup\markoverwith{#1\rule[-0.5ex]{2pt}{0.4pt}}\ULon}
% ESHUnderwave produces a wavy underline
\DeclareRobustCommand*{\ESHUnderwave}[1]
  {\bgroup\markoverwith{#1\lower3.5\p@\hbox{\ESHSmallWaveFont\char58}}\ULon}
\font\ESHSmallWaveFont=lasyb10 scaled 400

% \ESHBoxSep is the vertical padding of \ESHFBox
\@ifundefined{ESHBoxSep}{\newlength{\ESHBoxSep}\setlength{\ESHBoxSep}{1pt}}{}

% \ESHFBox{#color}{#lineWidth}{#contents} wraps #contents in an border of width
% #lineWidth and of color #color.  The box has no horizontal padding, its
% vertical padding is determined by \ESHBoxSep, and it doesn't affect the height
% of the current line.
\newdimen\ESHBoxTempDim%
\providecommand*{\ESHBox}[3]
  {\setlength{\fboxsep}{\ESHBoxSep}%
   \setlength{\fboxrule}{#2}%
   \setlength{\ESHBoxTempDim}{\dimexpr-\fboxsep-\fboxrule\relax}%
   \vphantom{#3}\smash{\fbox{\hspace*{\ESHBoxTempDim}#3\hspace*{\ESHBoxTempDim}}}}
\makeatother

% Environments and macros
%%%%%%%%%%%%%%%%%%%%%%%%%

% Internal plumbing needed to make the same code work with Inline, Block, and
% InlineBlock.  See http://tex.stackexchange.com/questions/336936/ for details.
\let\ESHSpecialChar\ignorespaces%
\let\ESHRaise\ignorespaces%
\let\ESHBol\ignorespaces%
\let\ESHEol\ignorespaces%
\let\ESHSpace\ignorespaces%
\let\ESHDash\ignorespaces%
\DeclareRobustCommand*{\ESHInlineInternalSetup}
  {\def\ESHSpecialChar{\ESHInlineSpecialChar}\def\ESHRaise{\ESHInlineRaise}%
   \def\ESHStrut{\relax}\def\ESHBol{\relax}\def\ESHEol{\newline}\def\ESHSpace{\ }%
   \def\ESHDash{-}}
\DeclareRobustCommand*{\ESHInlineBlockInternalSetup}
  {\def\ESHSpecialChar{\ESHBlockSpecialChar}\def\ESHRaise{\ESHBlockRaise}%
   \setlength{\ESHBaselineskip}{\baselineskip}\def\ESHStrut{\ESHBlockStrut}%
   \def\ESHBol{\-}\def\ESHEol{\cr}\def\ESHSpace{~}\def\ESHDash{\hbox{-}\nobreak}}
\DeclareRobustCommand*{\ESHBlockInternalSetup}
  {\def\ESHSpecialChar{\ESHBlockSpecialChar}\def\ESHRaise{\ESHBlockRaise}%
   \setlength{\ESHBaselineskip}{\baselineskip}\def\ESHStrut{\ESHBlockStrut}%
   \def\ESHBol{\-}\def\ESHEol{\newline}\def\ESHSpace{~}\def\ESHDash{\hbox{-}\nobreak}}

% Basic setup used when entering each type of environment or macro
% See http://tex.stackexchange.com/questions/22852 for \leavevmode
% \ESHBlockBasicSetup used to set \parskip to 0, but \ESHEol isn't \par anymore
\providecommand*{\ESHInlineBasicSetup}
  {\leavevmode\ESHNoHyphens\ESHInlineFont}
\providecommand*{\ESHInlineBlockBasicSetup}
  {\ESHNoHyphens\ESHInlineBlockFont\ESHConstantSpace}
\providecommand*{\ESHBlockBasicSetup}
  {\setlength{\parindent}{0pt}\raggedright\ESHNoHyphens%
   \ESHFont\ESHConstantSpace}

\makeatletter
% \ESHInline is used for inline code
% Note the extra pair of braces in the definition
\@ifundefined{ESHInline}
  {\DeclareRobustCommand*{\ESHInline}[1]{{\ESHText{\ESHInlineInternalSetup\ESHInlineBasicSetup#1}}}}{}

% \ESHInlineBlock is used for inline code blocks
\@ifundefined{ESHInlineBlock}
  {\newenvironment{ESHInlineBlock}
     {\ESHInlineBlockInternalSetup\ESHInlineBlockBasicSetup\begin{tabular}{@{}l@{}}}
     {\end{tabular}}}{}

% \ESHSkip is the amount to skip before and after an \ESHBlock
\@ifundefined{ESHSkip}{\newlength{\ESHSkip}\setlength{\ESHSkip}{\baselineskip}}{}

% \ESHBlock is used for code blocks
\@ifundefined{ESHBlock}
  {\newenvironment{ESHBlock}
     {\par\addvspace{\ESHSkip}\ESHBlockInternalSetup\ESHBlockBasicSetup}
     {\par\addvspace{\ESHSkip}}}{}
\makeatother

%% \input wrappers
%%%%%%%%%%%%%%%%%%

\DeclareRobustCommand*{\ESHInputInline}[1]{\ESHInline{\input{#1}}}
\DeclareRobustCommand*{\ESHInputInlineBlock}[1]{\begin{ESHInlineBlock}\input{#1}\end{ESHInlineBlock}}
\DeclareRobustCommand*{\ESHInputBlock}[1]{\begin{ESHBlock}\input{#1}\end{ESHBlock}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \ESHpv: ESH Precomputed-Verbs support %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Adapted from https://tex.stackexchange.com/questions/336837/

%% Utilities

% \ESHpvEnterVerbMode sets all specials to catcode 12
% * \@makeother sets the catcode of its argument to 12 (other)
% * \dospecials applies \do to each special character
% (see http://tex.stackexchange.com/questions/12721/control-command-arguments)
\makeatletter
\def\ESHpvEnterVerbMode{\let\do\@makeother\dospecials}
\makeatother

\def\ESHpvNotFoundMessage#1{No highlighting found for "#1"; falling back to "texttt".}
% \ESHpvNotFound issues a warning and prints its argument in tt
\def\ESHpvNotFound#1{\PackageWarning{ESH}{\ESHpvNotFoundMessage{#1}}\texttt{#1}}

%% Defining substitutions

% ESHpvReadAndDefineSubstitution{#A}#B#C#B#D maps #A-\detokenize{#C} to #D
\def\ESHpvReadAndDefineSubstitution#1#2{%
  % \tmp reads everything up to the next separator (#2), restores catcodes
  % (\endgroup), and calls \ESHpvDefineSubstitution on the code it read.
  \def\tmp##1#2{\endgroup\ESHpvDefineSubstitution{#1}{##1}}\tmp}

% ESHpvDefineSubstitution{#A}{#B}#C maps #A-\detokenize{#B} to #C
\def\ESHpvDefineSubstitution#1#2{\expandafter\def\csname #1-\detokenize{#2}\endcsname}

%% Applying substitutions

% ESHpvReadAndSubstitute{#A}#B#C#B looks up #A-\detokenize{#C}
\def\ESHpvReadAndSubstitute#1#2{%
  % \tmp reads everything up to the next separator (#2), restores catcodes
  % (\endgroup), and calls \ESHpvSubstitute on the code it read.
  \def\tmp##1#2{\endgroup\ESHpvSubstitute{#1}{##1}}\tmp}

% \ESHpvSubstitute{#A}{#B} looks up #A-\detokenize{#B} and substitutes it
\def\ESHpvSubstitute#1#2{%
  \expandafter\ifx\csname #1-\detokenize{#2}\endcsname\relax
  \ESHpvNotFound{\detokenize{#2}}%
  \else
  \csname #1-\detokenize{#2}\expandafter\endcsname
  \fi}

%% High-level interface

\def\ESHpvLookup#1{\begingroup\ESHpvEnterVerbMode\ESHpvReadAndSubstitute{#1}}
\def\ESHpvDefine#1{\begingroup\ESHpvEnterVerbMode\ESHpvReadAndDefineSubstitution{#1}}
